<div class="walking-form-card"
     data-controller="generate-circuit draggable-panel"
     data-generate-circuit-api-key-value="<%= ENV['MAPBOX_API_KEY'] %>"
     data-action="mousedown->draggable-panel#startDrag
                  touchstart->draggable-panel#startDrag:!passive
                  mousemove@window->draggable-panel#drag
                  touchmove@window->draggable-panel#drag:!passive
                  mouseup@window->draggable-panel#endDrag
                  touchend@window->draggable-panel#endDrag">

    <!-- Drag Handle -->
    <div class="drag-handle"
         data-draggable-panel-target="handle">
      <div class="drag-indicator"></div>
      <button type="button" class="drag-close-btn" data-action="click->draggable-panel#togglePanel" aria-label="Réduire/Agrandir">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
      </button>
    </div>

    <h2 class="page-title">Nouvelle balade</h2>
    <%= form_with model: @walking, local: true, class: "walk-form", data: { turbo: false } do |f| %>
      <div class="form-group"
           data-controller="address-autocomplete"
           data-address-autocomplete-api-key-value="<%= ENV['MAPBOX_API_KEY'] %>">
        <%= f.label :address, "Point de départ" %>
        <div class="autocomplete-wrapper">
          <%= f.text_field :address,
              class: "form-input",
              placeholder: "Entrez une adresse...",
              data: { address_autocomplete_target: "address" },
              autocomplete: "off"
          %>
          <%= f.hidden_field :latitude, data: { address_autocomplete_target: "latitude", generate_circuit_target: "latitude" } %>
          <%= f.hidden_field :longitude, data: { address_autocomplete_target: "longitude", generate_circuit_target: "longitude" } %>
          <%# Hidden field to store the generated  coordinates %>
          <%= hidden_field_tag :coordinates, params[:coordinates], data: { generate_circuit_target: "circuitCoordinates" } %>
        </div>
        <div class="autocomplete-results" data-address-autocomplete-target="results"></div>
      </div>

      <div class="form-group">
        <%= f.label :wanted_duration, "Durée de la balade" %>
        <%= f.select :wanted_duration,
            options_for_select([
              ["15 minutes", 15],
              ["30 minutes", 30],
              ["45 minutes", 45],
              ["1 heure", 60],
              ["1h30", 90],
              ["2 heures", 120]
            ], 45),
            {},
            class: "form-input form-select",
            data: { generate_circuit_target: "duration" }
        %>
      </div>


      <button type="button" class="btn btn-primary btn-lg w-full" data-action="click->generate-circuit#initializeWalk" data-generate-circuit-target="previewButton">
        Prévisualiser le circuit
      </button>
      <div style="display: none; text-align: center; padding: 1rem;" data-generate-circuit-target="loadingIndicator">
        <div style="display: inline-block; width: 24px; height: 24px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <p style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;">Récupération de votre position...</p>
      </div>
      <style>
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
      </style>
      <%= f.submit "Valider et Créer la balade",
          class: "btn btn-success btn-lg w-full mt-3",
          style: "display: none;",
          data: { generate_circuit_target: "submitButton" }
      %>
    <% end %>
  </div>
