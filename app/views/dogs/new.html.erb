<% content_for :title, "Nouveau chien" %>

<div class="dog-show-container">
  <div class="dog-card">
    <%= simple_form_for @dog, html: { multipart: true, class: "dog-edit-form" } do |f| %>

      <div class="dog-profile-header">
        <div class="dog-profile-image-wrapper dog-profile-editable">
          <%= f.label :photo do %>
            <div class="dog-profile-placeholder" id="photo-placeholder">
              <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                <circle cx="12" cy="13" r="4"></circle>
              </svg>
            </div>
            <img id="profile-preview" class="dog-profile-image" src="" alt="" style="display: none;">
            <%= f.file_field :photo, accept: "image/*", class: "dog-photo-input", id: "photo-input" %>
          <% end %>
        </div>
      </div>

      <div class="dog-info-group">
        <span class="dog-info-label">Mon chien</span>
        <%= f.input :name, label: false, placeholder: "Nom du chien", wrapper: false, input_html: { class: "dog-edit-input" } %>
      </div>

      <div class="dog-info-group">
        <span class="dog-info-label">Âge</span>
        <%= f.input :age, label: false, placeholder: "Âge", wrapper: false, input_html: { class: "dog-edit-input", type: "number", min: 0 } %>
      </div>

      <div class="dog-info-group">
        <span class="dog-info-label">Race</span>
        <div data-controller="breed-list" class="dog-breed-wrapper">
          <input type="hidden" name="dog[race]" id="dog_breed" data-breed-list-target="hiddenInput">
          <input type="text" data-action="input->breed-list#filter focus->breed-list#showList" data-breed-list-target="queryInput" id="breed-input" placeholder="Rechercher..." autocomplete="off" class="dog-edit-input">
          <div class="breed-list d-none" data-breed-list-target="list">
            <% Dog::BREEDS.each do |breed| %>
              <a class="breed-suggestion" data-action="click->breed-list#select" data-breed="<%= breed %>"><%= breed %></a>
            <% end %>
          </div>
        </div>
      </div>

      <div class="dog-info-group">
        <span class="dog-info-label">Taille</span>
        <div class="dog-size-options">
          <%= f.collection_radio_buttons :size, [["Petit", "Petit"], ["Moyen", "Moyen"], ["Grand", "Grand"]], :last, :first do |b| %>
            <label class="dog-size-btn"><%= b.radio_button %><span><%= b.text %></span></label>
          <% end %>
        </div>
      </div>

      <div class="dog-info-group">
        <span class="dog-info-label">Personnalité & Traits</span>
        <div class="dog-tags-container">
          <%= f.collection_check_boxes :tag_ids, Tag.all, :id, :name do |b| %>
            <%= b.check_box(class: "d-none") %>
            <%= b.label(class: "dog-tag dog-tag--selectable") { b.object.name.capitalize } %>
          <% end %>
        </div>
      </div>

      <div class="dog-profile-actions">
        <%= f.submit "Créer le profil", class: "dog-profile-btn" %>
      </div>

    <% end %>
  </div>
</div>

<script>
  function initPhotoPreview() {
    const input = document.getElementById('photo-input');
    const preview = document.getElementById('profile-preview');
    const placeholder = document.getElementById('photo-placeholder');

    if (input && !input.dataset.initialized) {
      input.dataset.initialized = 'true';
      input.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            preview.src = e.target.result;
            preview.style.display = 'block';
            placeholder.style.display = 'none';
          };
          reader.readAsDataURL(file);
        }
      });
    }
  }

  // Support pour Turbo et chargement classique
  document.addEventListener('DOMContentLoaded', initPhotoPreview);
  document.addEventListener('turbo:load', initPhotoPreview);
  document.addEventListener('turbo:render', initPhotoPreview);

  // Exécution immédiate si le DOM est déjà prêt
  if (document.readyState !== 'loading') {
    initPhotoPreview();
  }
</script>
